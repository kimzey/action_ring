# MacRing — Data Models Reference

> Swift data models derived from `MacRing_PRD_v2.md` §15.
> All models use immutable patterns (structs with `var` only where needed for mutation-via-copy).

---

## Core Models

### RingProfile

```swift
struct RingProfile: Codable, Identifiable {
    let id: UUID
    var name: String
    var bundleId: String?          // nil = category or default profile
    var category: AppCategory?
    var slots: [RingSlot]
    var slotCount: Int             // 4, 6, or 8
    var isDefault: Bool
    var mcpServers: [String]       // associated MCP server IDs
    var createdAt: Date
    var updatedAt: Date
    var source: ProfileSource
}

enum ProfileSource: String, Codable {
    case builtin    // shipped with app
    case user       // user-created
    case ai         // generated by Claude
    case community  // imported from community
    case mcp        // MCP-enhanced preset
}

enum AppCategory: String, Codable {
    case ide, browser, design, communication
    case productivity, media, system, gaming
}
```

### RingSlot

```swift
struct RingSlot: Codable, Identifiable {
    let id: UUID
    var position: Int           // 0-indexed, 0–7
    var label: String
    var icon: String            // SF Symbol name
    var action: RingAction
    var isEnabled: Bool
    var color: SlotColor?       // nil = use action type default
}
```

### RingAction

```swift
enum RingAction: Codable {
    case keyboardShortcut(KeyboardShortcutAction)
    case launchApplication(LaunchAppAction)
    case openURL(OpenURLAction)
    case systemAction(SystemActionType)
    case shellScript(ShellScriptAction)
    case appleScript(AppleScriptAction)
    case shortcutsApp(ShortcutsAppAction)
    case textSnippet(TextSnippetAction)
    case openFileFolder(FileFolderAction)
    case workflow(WorkflowAction)
    case subRing(SubRingAction)
    case mcpToolCall(MCPToolAction)       // Phase 5
    case mcpWorkflow(MCPWorkflowAction)   // Phase 5
}

struct KeyboardShortcutAction: Codable {
    let modifiers: [KeyModifier]  // .cmd, .shift, .option, .control
    let key: String               // e.g., "s", "F5", "space"
}

enum SystemActionType: String, Codable {
    case lockScreen, screenshot, screenshotArea
    case volumeUp, volumeDown, volumeMute
    case brightnessUp, brightnessDown
    case missionControl, notificationCenter, launchpad
}
```

### MCP Models

```swift
struct MCPToolAction: Codable {
    let serverId: String              // e.g., "github"
    let toolName: String              // e.g., "create_pull_request"
    let parameters: [String: String]  // pre-filled params (supports templates)
    let displayName: String
}

struct MCPWorkflowAction: Codable {
    let name: String
    let description: String
    let steps: [MCPWorkflowStep]
}

struct MCPWorkflowStep: Codable {
    let action: MCPToolAction
    let stopOnError: Bool
    let outputMapping: [String: String]?
}
```

---

## Behavior Tracking Models

### ActionEvent

```swift
struct ActionEvent: Codable {
    let id: UUID
    let bundleId: String
    let actionType: String          // RingAction case name
    let actionLabel: String
    let slotPosition: Int
    let timestamp: Date
}
```

### BehaviorSequence

```swift
struct BehaviorSequence: Codable, Identifiable {
    let id: UUID
    let actions: [ActionEvent]      // ordered list within time window
    let bundleId: String
    let timestamp: Date
    let embedding: [Float]?         // 512-dim NLEmbedding vector (nil if not yet computed)
    let clusterId: Int?             // assigned after clustering (nil if unassigned)
}
```

### UsageRecord

```swift
struct UsageRecord: Codable {
    let id: UUID
    let bundleId: String
    let actionType: String
    let actionLabel: String
    let count: Int
    let lastUsed: Date
    let updatedAt: Date
}
```

---

## AI Models

### AISuggestion

```swift
struct AISuggestion: Codable, Identifiable {
    let id: UUID
    let bundleId: String
    let suggestedSlot: RingSlot
    let confidence: Double          // 0.0–1.0
    let reason: String
    let source: SuggestionSource
    let createdAt: Date
    var status: SuggestionStatus
}

enum SuggestionSource: String, Codable {
    case haiku          // Claude Haiku analysis
    case ruleBased      // offline frequency threshold
    case semantic       // derived from cluster interpretation
}

enum SuggestionStatus: String, Codable {
    case pending, accepted, dismissed
}
```

### BehaviorCluster

```swift
struct BehaviorCluster: Codable, Identifiable {
    let id: Int
    let bundleId: String
    let representativeSequences: [UUID]  // references to BehaviorSequence
    let centroid: [Float]               // averaged embedding vector
    let frequency: Double               // occurrences per day
    let silhouetteScore: Double
    let interpretation: ClusterInterpretation?
    let createdAt: Date
}

struct ClusterInterpretation: Codable {
    let workflowName: String
    let description: String
    let suggestedAction: RingAction
    let confidence: Double
}
```

---

## MCP Server Models

### MCPServer

```swift
struct MCPServer: Codable, Identifiable {
    let id: String                  // e.g., "github"
    var packageName: String         // e.g., "@modelcontextprotocol/server-github"
    var transport: MCPTransport
    var isEnabled: Bool
    var autoStart: Bool
    var categories: [AppCategory]
    var status: MCPServerStatus
    var installedAt: Date
}

enum MCPTransport: String, Codable {
    case stdio
    case httpSSE
}

enum MCPServerStatus: String, Codable {
    case connected, disconnected, connecting, error
}
```

### MCPTool

```swift
struct MCPTool: Codable, Identifiable {
    let id: String                  // "{serverId}.{toolName}"
    let serverId: String
    let toolName: String
    let description: String
    let parameters: [MCPParameter]
    let categories: [AppCategory]
    let cachedAt: Date
}

struct MCPParameter: Codable {
    let name: String
    let type: String
    let description: String
    let required: Bool
    let defaultValue: String?
}
```

---

## Trigger Model

```swift
struct MouseTrigger: Codable {
    let buttonIndex: Int            // CGMouseButton integer (0-31)
    let holdDurationMs: Int         // default: 200ms
    let brand: String?              // optional, for display only
    let updatedAt: Date
}
```

---

## Database Table Mappings

| Model | Table | Primary Key |
|-------|-------|-------------|
| `RingProfile` | `profiles` | `id` (UUID) |
| `RingSlot` | stored as JSON in `profiles.slots` | — |
| `ActionEvent` | `raw_interactions` | `id` (UUID) |
| `UsageRecord` | `usage_records` | `id` (UUID) |
| `BehaviorSequence` | `behavior_sequences` | `id` (UUID) |
| `AISuggestion` | `ai_suggestions` | `id` (UUID) |
| `BehaviorCluster` | `behavior_clusters` | `id` (Int) |
| Embedding vectors | `vector_store` | `sequenceId` (UUID) |
| `MCPServer` | `mcp_servers` | `id` (String) |
| `MCPTool` | `mcp_tools` | `id` (String) |
| MCP credentials | Keychain | `macring.mcp.{serverId}` |
| `MouseTrigger` | `triggers` | `id` (Int, single row) |
| Shortcut presets | `shortcut_presets` | `bundleId` (String) |

---

## Immutability Pattern

All models are Swift `struct`s. Mutations produce new copies:

```swift
// WRONG — mutation
profile.name = "New Name"

// CORRECT — copy-on-write
let updatedProfile = RingProfile(
    id: profile.id,
    name: "New Name",
    // ... all other fields unchanged
    updatedAt: Date()
)
```

Use `ProfileManager.update()` which handles persistence + publishing the new value via Combine.
